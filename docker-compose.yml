services:
  # VPN Gateway
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "192.168.1.101:8888:8888/tcp"  # HTTP proxy bound to enp3s0
      - "192.168.1.101:9091:9091"      # Transmission on enp3s0
      - "192.168.1.101:8080:8080"      # SABnzbd on enp3s0
      - "192.168.1.101:8112:8112"      # Deluge web UI on enp3s0
      - "192.168.1.101:58846:58846"    # Deluge daemon on enp3s0
    volumes:
      - ./gluetun:/gluetun
      - /home/user/ssd-cache/downloads:/downloads
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=openvpn
      - OPENVPN_USER=${PROTON_USERNAME}
      - OPENVPN_PASSWORD=${PROTON_PASSWORD}
      - SERVER_COUNTRIES=Canada
      # Remove invalid categories - ProtonVPN doesn't use categories in Gluetun
      # - SERVER_CATEGORIES=P2P  # REMOVE THIS LINE
      - FREE_ONLY=off  # Access Plus servers
      - VPN_PORT_FORWARDING=on  # Enable port forwarding
      - VPN_PORT_FORWARDING_PROVIDER=protonvpn
      - OPENVPN_PROTOCOL=udp
      - OPENVPN_CIPHERS=AES-256-GCM  # Fixed: use CIPHERS not CIPHER
      - FIREWALL_OUTBOUND_SUBNETS=192.168.50.0/24,172.18.0.0/16
      - FIREWALL_VPN_INPUT_PORTS=9091,8080,8112,58846
      - FIREWALL_INPUT_PORTS=8888
      - HTTPPROXY=on
      - HTTPPROXY_LOG=on
      - BLOCK_MALICIOUS=on
      - BLOCK_ADS=off
      - DOT=on
      - DOT_PROVIDERS=cloudflare
      - TZ=${TIMEZONE}
      - PUID=1001
      - PGID=1002
      - LOG_LEVEL=info  # Change back to info
    networks:
      vpn_network:
        ipv4_address: 172.20.0.10
    restart: unless-stopped
    

  # Cloudflare Tunnel
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - management_network
    restart: unless-stopped
    depends_on:
      - traefik

  # Landing page
  landing:
    image: nginx:alpine
    container_name: landing
    volumes:
      - ./www:/usr/share/nginx/html:ro
    networks:
      - management_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.landing.rule=Host(`yourdomain.example.com`) && Path(`/`)"
      - "traefik.http.routers.landing.entrypoints=web"
      - "traefik.http.services.landing.loadbalancer.server.port=80"

  # Traefik
  traefik:
    image: traefik:v3.0
    container_name: traefik
    ports:
      - "192.168.1.100:80:80"      # HTTP on enp2s0
      - "192.168.1.100:8090:8080"  # Dashboard on enp2s0
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--log.level=INFO"
      - "--accesslog=true"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/logs:/logs
    networks:
      - management_network
      - arr_network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`yourdomain.example.com`) && PathPrefix(`/traefik`)"
      - "traefik.http.routers.dashboard.service=api@internal"

  # Download Clients (VPN-routed)
  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    network_mode: "service:gluetun"
    environment:
      - PUID=1001
      - PGID=1002
      - TZ=${TIMEZONE}
      - UMASK=002
    volumes:
      - ./sabnzbd:/config
      - /data/usenet:/data/usenet
      - /home/user/ssd-cache/downloads:/downloads
    depends_on:
      gluetun:
        condition: service_started
    restart: unless-stopped

  deluge:
    image: lscr.io/linuxserver/deluge:latest
    container_name: deluge
    network_mode: "service:gluetun"
    environment:
      - PUID=1001
      - PGID=1002
      - TZ=${TIMEZONE}
      - UMASK=002
    volumes:
      - ./deluge:/config
      - /data/torrents:/data/torrents
      - /home/user/ssd-cache/downloads:/downloads
    depends_on:
      gluetun:
        condition: service_started
    restart: unless-stopped

  # Media Server
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    ports:
      - "192.168.1.100:32400:32400"  # Bind to enp2s0 IP
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - PUID=1001
      - PGID=1002
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
      - TZ=${TIMEZONE}
    volumes:
      - ./plex:/config
      - /data/media:/data/media
      - /home/user/ssd-cache/transcode:/transcode
    networks:
      - management_network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.plex.rule=Host(`yourdomain.example.com`) && PathPrefix(`/plex`)"
      - "traefik.http.routers.plex.entrypoints=web"
      - "traefik.http.services.plex.loadbalancer.server.port=32400"

  # *arr Suite
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=1001
      - PGID=1002
      - TZ=${TIMEZONE}
      - UMASK=002
    volumes:
      - ./prowlarr:/config
      - /data:/data
    networks:
      - management_network
      - arr_network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prowlarr.rule=Host(`yourdomain.example.com`) && PathPrefix(`/prowlarr`)"
      - "traefik.http.routers.prowlarr.entrypoints=web"
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=1001
      - PGID=1002
      - TZ=${TIMEZONE}
      - UMASK=002
    volumes:
      - ./sonarr:/config
      - /data:/data
      - /home/user/ssd-cache/downloads:/downloads
    networks:
      - management_network
      - arr_network
      - vpn_network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sonarr.rule=Host(`yourdomain.example.com`) && PathPrefix(`/sonarr`)"
      - "traefik.http.routers.sonarr.entrypoints=web"
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=1001
      - PGID=1002
      - TZ=${TIMEZONE}
      - UMASK=002
    volumes:
      - ./radarr:/config
      - /data:/data
      - /home/user/ssd-cache/downloads:/downloads
    networks:
      - management_network
      - arr_network
      - vpn_network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.radarr.rule=Host(`yourdomain.example.com`) && PathPrefix(`/radarr`)"
      - "traefik.http.routers.radarr.entrypoints=web"
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"

  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=1001
      - PGID=1002
      - TZ=${TIMEZONE}
      - UMASK=002
    volumes:
      - ./bazarr:/config
      - /data/media:/data/media
    networks:
      - management_network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bazarr.rule=Host(`yourdomain.example.com`) && PathPrefix(`/bazarr`)"
      - "traefik.http.routers.bazarr.entrypoints=web"
      - "traefik.http.services.bazarr.loadbalancer.server.port=6767"

  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    environment:
      - PUID=1001
      - PGID=1002
      - TZ=${TIMEZONE}
      - UMASK=002
    volumes:
      - ./lidarr:/config
      - /data:/data
      - /home/user/ssd-cache/downloads:/downloads
    networks:
      - management_network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.lidarr.rule=Host(`yourdomain.example.com`) && PathPrefix(`/lidarr`)"
      - "traefik.http.routers.lidarr.entrypoints=web"
      - "traefik.http.services.lidarr.loadbalancer.server.port=8686"

  readarr:
    image: ghcr.io/hotio/readarr:latest
    container_name: readarr
    environment:
      - PUID=1001
      - PGID=1002
      - TZ=${TIMEZONE}
      - UMASK=002
    volumes:
      - ./readarr:/config
      - /data:/data
      - /home/user/ssd-cache/downloads:/downloads
    networks:
      - management_network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.readarr.rule=Host(`yourdomain.example.com`) && PathPrefix(`/readarr`)"
      - "traefik.http.routers.readarr.entrypoints=web"
      - "traefik.http.services.readarr.loadbalancer.server.port=8787"

  # SSO Authentication
  authelia:
    image: authelia/authelia:4.38
    container_name: authelia
    ports:
      - "192.168.1.100:9091:9091"
    volumes:
      - ./authelia:/config
      - ./authelia/secrets:/secrets:ro
    environment:
      - TZ=${TIMEZONE}
    networks:
      - management_network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authelia.rule=Host(`yourdomain.example.com`) && PathPrefix(`/auth`)"
      - "traefik.http.middlewares.authelia.forwardauth.address=http://authelia:9091/api/authz/forward-auth"

  # DNS and Ad-blocking
  adguardhome:
    image: adguard/adguardhome:latest
    container_name: adguardhome
    ports:
      - "192.168.1.100:53:53/tcp"
      - "192.168.1.100:53:53/udp"
      - "192.168.1.100:3001:3000/tcp"
    volumes:
      - ./adguard/work:/opt/adguardhome/work
      - ./adguard/conf:/opt/adguardhome/conf
    networks:
      - management_network
    restart: unless-stopped

  # Photo Management
  immich-server:
    container_name: immich-server
    image: ghcr.io/immich-app/immich-server:release
    command: ['start.sh', 'immich']
    ports:
      - "192.168.1.100:2283:3001"
    volumes:
      - /data/immich/library:/usr/src/app/upload
    environment:
      - DB_PASSWORD=${IMMICH_DB_PASSWORD}
      - DB_USERNAME=postgres
      - DB_DATABASE_NAME=immich
      - DB_HOSTNAME=immich-postgres
      - REDIS_HOSTNAME=immich-redis
    depends_on:
      - immich-redis
      - immich-postgres
    networks:
      - management_network
    restart: unless-stopped

  immich-postgres:
    container_name: immich-postgres
    image: tensorchord/pgvecto-rs:pg14-v0.2.0
    environment:
      - POSTGRES_PASSWORD=${IMMICH_DB_PASSWORD}
      - POSTGRES_USER=postgres
      - POSTGRES_DB=immich
    volumes:
      - /data/immich/postgres:/var/lib/postgresql/data
    networks:
      - management_network
    restart: unless-stopped

  immich-redis:
    container_name: immich-redis
    image: redis:6.2-alpine
    networks:
      - management_network
    restart: unless-stopped

  # Korean Subtitle Service (OpenSubtitles.com API)
  korsub:
    build: ./korsub
    container_name: korsub
    environment:
      - TZ=${TIMEZONE}
      - PORT=7272
      - LOG_LEVEL=INFO
      - MEDIA_PATH=/data/media
      - OPENSUBTITLES_API_KEY=${OPENSUBTITLES_API_KEY}
      - RADARR_URL=http://radarr:7878/radarr
      - RADARR_API_KEY=${RADARR_API_KEY}
      - SONARR_URL=http://sonarr:8989/sonarr
      - SONARR_API_KEY=${SONARR_API_KEY}
      - SCAN_INTERVAL_HOURS=6
    volumes:
      - /data:/data
    networks:
      - management_network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.korsub.rule=Host(`yourdomain.example.com`) && PathPrefix(`/korsub`)"
      - "traefik.http.routers.korsub.entrypoints=web"
      - "traefik.http.services.korsub.loadbalancer.server.port=7272"
      - "traefik.docker.network=mediaserver_management_network"
      - "traefik.http.middlewares.korsub-stripprefix.stripprefix.prefixes=/korsub"
      - "traefik.http.routers.korsub.middlewares=korsub-stripprefix"

  # Automated Updates
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    environment:
      - TZ=${TIMEZONE}
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_SCHEDULE=0 0 3 * * SUN
      - WATCHTOWER_LOG_LEVEL=info
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped

networks:
  vpn_network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-vpn
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
    internal: false

  management_network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-mgmt
    ipam:
      config:
        - subnet: 172.18.0.0/16
          gateway: 172.18.0.1

  arr_network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-arr
    ipam:
      config:
        - subnet: 172.19.0.0/16
          gateway: 172.19.0.1
    internal: true
